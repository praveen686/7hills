● Implementing Phase 27.1 now — adding exit logic + proper tags to funding_bias.                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                  
● Read(crates/quantlaxmi-strategy/src/strategies/funding_bias.rs)                                                                                                                                                                                                                                                 
  ⎿  Read 468 lines                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                  
● Now implementing Phase 27.1: exit logic + proper tags.                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                  
● Write(crates/quantlaxmi-strategy/src/strategies/funding_bias.rs)                                                                                                                                                                                                                                                
  ⎿  Added 242 lines, removed 58 lines                                                                                                                                                                                                                                                                            
       1 -//! FundingBias Strategy v2                                                                                                                                                                                                                                                                             
       1 +//! FundingBias Strategy v2.1                                                                                                                                                                                                                                                                           
       2  //!                                                                                                                                                                                                                                                                                                     
       3 -//! Migrated from backtest.rs to use Phase 2 Strategy SDK.                                                                                                                                                                                                                                              
       3 +//! Phase 27.1: Added exit logic + hysteresis band for complete entry/exit cycles.                                                                                                                                                                                                                      
       4  //!                                                                                                                                                                                                                                                                                                     
       5  //! ## Strategy Logic                                                                                                                                                                                                                                                                                   
       6 +//! Entry:                                                                                                                                                                                                                                                                                              
       7  //! - Goes SHORT perp when funding rate > threshold (longs pay shorts)                                                                                                                                                                                                                                  
       8  //! - Goes LONG perp when funding rate < -threshold (shorts pay longs)                                                                                                                                                                                                                                  
       9  //!                                                                                                                                                                                                                                                                                                     
      10 +//! Exit (hysteresis):                                                                                                                                                                                                                                                                                  
      11 +//! - Exit LONG when funding rate >= exit_band (reverted toward positive)                                                                                                                                                                                                                               
      12 +//! - Exit SHORT when funding rate <= -exit_band (reverted toward negative)                                                                                                                                                                                                                             
      13 +//!                                                                                                                                                                                                                                                                                                     
      14 +//! Flip:                                                                                                                                                                                                                                                                                               
      15 +//! - If long and funding crosses +threshold → exit long, enter short                                                                                                                                                                                                                                   
      16 +//! - If short and funding crosses -threshold → exit short, enter long                                                                                                                                                                                                                                  
      17 +//!                                                                                                                                                                                                                                                                                                     
      18  //! ## Fixed-Point Config                                                                                                                                                                                                                                                                               
      19  //! All numeric fields use mantissa + exponent, no f64.                                                                                                                                                                                                                                                 
      20                                                                                                                                                                                                                                                                                                          
     ...                                                                                                                                                                                                                                                                                                          
      24  /// Strategy name constant.                                                                                                                                                                                                                                                                             
      25  pub const FUNDING_BIAS_NAME: &str = "funding_bias";                                                                                                                                                                                                                                                     
      26                                                                                                                                                                                                                                                                                                          
      27 -/// Strategy version.                                                                                                                                                                                                                                                                                   
      28 -pub const FUNDING_BIAS_VERSION: &str = "2.0.0";                                                                                                                                                                                                                                                         
      27 +/// Strategy version (2.1.0 = Phase 27.1 with exit logic).                                                                                                                                                                                                                                              
      28 +pub const FUNDING_BIAS_VERSION: &str = "2.1.0";                                                                                                                                                                                                                                                         
      29                                                                                                                                                                                                                                                                                                          
      30  /// Configuration for FundingBias strategy.                                                                                                                                                                                                                                                             
      31  ///                                                                                                                                                                                                                                                                                                     
     ...                                                                                                                                                                                                                                                                                                          
      34  /// NO f64 fields - this ensures deterministic config hashing.                                                                                                                                                                                                                                          
      35  #[derive(Debug, Clone, Serialize, Deserialize)]                                                                                                                                                                                                                                                         
      36  pub struct FundingBiasConfig {                                                                                                                                                                                                                                                                          
      37 -    /// Funding rate threshold (mantissa, exponent = -6).                                                                                                                                                                                                                                               
      38 -    /// e.g., 100 = 0.0001 = 1 basis point funding rate.                                                                                                                                                                                                                                                
      37 +    /// Funding rate threshold for entry (mantissa).                                                                                                                                                                                                                                                    
      38 +    /// e.g., 100 with exp -6 = 0.0001 = 1 basis point funding rate.                                                                                                                                                                                                                                    
      39      ///                                                                                                                                                                                                                                                                                                 
      40 -    /// The strategy will:                                                                                                                                                                                                                                                                              
      40 +    /// Entry rules:                                                                                                                                                                                                                                                                                    
      41      /// - SHORT when funding_rate > threshold (longs pay shorts)                                                                                                                                                                                                                                        
      42      /// - LONG when funding_rate < -threshold (shorts pay longs)                                                                                                                                                                                                                                        
      43      pub threshold_mantissa: i64,                                                                                                                                                                                                                                                                        
     ...                                                                                                                                                                                                                                                                                                          
      45      /// Threshold exponent (typically -6 for funding rates).                                                                                                                                                                                                                                            
      46      pub threshold_exponent: i8,                                                                                                                                                                                                                                                                         
      47                                                                                                                                                                                                                                                                                                          
      48 +    /// Exit band for hysteresis (mantissa, same exponent as threshold).                                                                                                                                                                                                                                
      49 +    /// Default: threshold_mantissa / 2                                                                                                                                                                                                                                                                 
      50 +    ///                                                                                                                                                                                                                                                                                                 
      51 +    /// Exit rules:                                                                                                                                                                                                                                                                                     
      52 +    /// - Exit LONG when funding_rate >= exit_band                                                                                                                                                                                                                                                      
      53 +    /// - Exit SHORT when funding_rate <= -exit_band                                                                                                                                                                                                                                                    
      54 +    #[serde(default)]                                                                                                                                                                                                                                                                                   
      55 +    pub exit_band_mantissa: Option<i64>,                                                                                                                                                                                                                                                                
      56 +                                                                                                                                                                                                                                                                                                        
      57      /// Position size (mantissa, uses qty_exponent).                                                                                                                                                                                                                                                    
      58      /// e.g., 1_000_000 with exp -8 = 0.01 BTC.                                                                                                                                                                                                                                                         
      59      pub position_size_mantissa: i64,                                                                                                                                                                                                                                                                    
     ...                                                                                                                                                                                                                                                                                                          
      62              // 100 with exp -6 = 0.0001 = 1 basis point                                                                                                                                                                                                                                                 
      63              threshold_mantissa: 100,                                                                                                                                                                                                                                                                    
      64              threshold_exponent: -6,                                                                                                                                                                                                                                                                     
      65 +            // Default exit band = threshold / 2                                                                                                                                                                                                                                                        
      66 +            exit_band_mantissa: None,                                                                                                                                                                                                                                                                   
      67              // 1_000_000 with exp -8 = 0.01 BTC                                                                                                                                                                                                                                                         
      68              position_size_mantissa: 1_000_000,                                                                                                                                                                                                                                                          
      69              qty_exponent: -8,                                                                                                                                                                                                                                                                           
     ...                                                                                                                                                                                                                                                                                                          
      70      }                                                                                                                                                                                                                                                                                                   
      71  }                                                                                                                                                                                                                                                                                                       
      72                                                                                                                                                                                                                                                                                                          
      73 +impl FundingBiasConfig {                                                                                                                                                                                                                                                                                
      74 +    /// Get effective exit band (default = threshold / 2).                                                                                                                                                                                                                                              
      75 +    pub fn effective_exit_band(&self) -> i64 {                                                                                                                                                                                                                                                          
      76 +        self.exit_band_mantissa.unwrap_or(self.threshold_mantissa / 2)                                                                                                                                                                                                                                  
      77 +    }                                                                                                                                                                                                                                                                                                   
      78 +}                                                                                                                                                                                                                                                                                                       
      79 +                                                                                                                                                                                                                                                                                                        
      80  impl CanonicalBytes for FundingBiasConfig {                                                                                                                                                                                                                                                             
      81      fn canonical_bytes(&self) -> Vec<u8> {                                                                                                                                                                                                                                                              
      82          let mut buf = Vec::new();                                                                                                                                                                                                                                                                       
     ...                                                                                                                                                                                                                                                                                                          
      78          // Fields in fixed order                                                                                                                                                                                                                                                                        
      79          encode_i64(&mut buf, self.threshold_mantissa);                                                                                                                                                                                                                                                  
      80          encode_i8(&mut buf, self.threshold_exponent);                                                                                                                                                                                                                                                   
      81 +        encode_i64(&mut buf, self.effective_exit_band()); // Always encode effective value                                                                                                                                                                                                              
      82          encode_i64(&mut buf, self.position_size_mantissa);                                                                                                                                                                                                                                              
      83          encode_i8(&mut buf, self.qty_exponent);                                                                                                                                                                                                                                                         
      84          encode_i8(&mut buf, self.price_exponent);                                                                                                                                                                                                                                                       
     ...                                                                                                                                                                                                                                                                                                          
      104      }                                                                                                                                                                                                                                                                                                  
      105  }                                                                                                                                                                                                                                                                                                      
      106                                                                                                                                                                                                                                                                                                         
      107 -/// FundingBias Strategy v2.                                                                                                                                                                                                                                                                           
      107 +/// FundingBias Strategy v2.1.                                                                                                                                                                                                                                                                         
      108  ///                                                                                                                                                                                                                                                                                                    
      109 -/// Implements the Phase 2 Strategy trait:                                                                                                                                                                                                                                                             
      109 +/// Implements the Phase 2 Strategy trait with complete entry/exit lifecycle:                                                                                                                                                                                                                          
      110  /// - Authors DecisionEvent directly                                                                                                                                                                                                                                                                   
      111  /// - Returns DecisionOutput { decision, intents }                                                                                                                                                                                                                                                     
      112  /// - Uses fixed-point config (no f64)                                                                                                                                                                                                                                                                 
      113 +/// - Hysteresis exit band prevents flip-flop noise                                                                                                                                                                                                                                                    
      114  pub struct FundingBiasStrategy {                                                                                                                                                                                                                                                                       
      115      config: FundingBiasConfig,                                                                                                                                                                                                                                                                         
      116      config_hash: String,                                                                                                                                                                                                                                                                               
     ...                                                                                                                                                                                                                                                                                                          
      166                  "tag": tag,                                                                                                                                                                                                                                                                            
      167                  "funding_rate_mantissa": self.current_funding_rate_mantissa,                                                                                                                                                                                                                           
      168                  "funding_rate_exponent": self.config.threshold_exponent,                                                                                                                                                                                                                               
      169 -                "policy": "funding_bias_v2",                                                                                                                                                                                                                                                           
      169 +                "threshold_mantissa": self.config.threshold_mantissa,                                                                                                                                                                                                                                  
      170 +                "exit_band_mantissa": self.config.effective_exit_band(),                                                                                                                                                                                                                               
      171 +                "policy": "funding_bias_v2.1",                                                                                                                                                                                                                                                         
      172              }),                                                                                                                                                                                                                                                                                        
      173              ctx: CorrelationContext {                                                                                                                                                                                                                                                                  
      174                  run_id: Some(ctx.run_id.to_string()),                                                                                                                                                                                                                                                  
     ...                                                                                                                                                                                                                                                                                                          
      177          }                                                                                                                                                                                                                                                                                              
      178      }                                                                                                                                                                                                                                                                                                  
      179                                                                                                                                                                                                                                                                                                         
      180 -    /// Create an OrderIntent for execution.                                                                                                                                                                                                                                                           
      181 -    ///                                                                                                                                                                                                                                                                                                
      182 -    /// # Arguments                                                                                                                                                                                                                                                                                    
      183 -    /// * `parent_decision_id` - The decision that authored this intent                                                                                                                                                                                                                                
      184 -    /// * `ctx` - Strategy context with market state                                                                                                                                                                                                                                                   
      185 -    /// * `side` - Buy or Sell                                                                                                                                                                                                                                                                         
      186 -    /// * `tag` - Tracking tag                                                                                                                                                                                                                                                                         
      180 +    /// Create an OrderIntent for execution (market order).                                                                                                                                                                                                                                            
      181      fn create_intent(                                                                                                                                                                                                                                                                                  
      182          &self,                                                                                                                                                                                                                                                                                         
      183          parent_decision_id: Uuid,                                                                                                                                                                                                                                                                      
     ...                                                                                                                                                                                                                                                                                                          
      203              tag: Some(tag.to_string()),                                                                                                                                                                                                                                                                
      204          }                                                                                                                                                                                                                                                                                              
      205      }                                                                                                                                                                                                                                                                                                  
      206 +                                                                                                                                                                                                                                                                                                       
      207 +    /// Check if we should exit a long position.                                                                                                                                                                                                                                                       
      208 +    fn should_exit_long(&self) -> bool {                                                                                                                                                                                                                                                               
      209 +        // Exit long when funding reverts toward positive (above exit band)                                                                                                                                                                                                                            
      210 +        self.current_funding_rate_mantissa >= self.config.effective_exit_band()                                                                                                                                                                                                                        
      211 +    }                                                                                                                                                                                                                                                                                                  
      212 +                                                                                                                                                                                                                                                                                                       
      213 +    /// Check if we should exit a short position.                                                                                                                                                                                                                                                      
      214 +    fn should_exit_short(&self) -> bool {                                                                                                                                                                                                                                                              
      215 +        // Exit short when funding reverts toward negative (below -exit band)                                                                                                                                                                                                                          
      216 +        self.current_funding_rate_mantissa <= -self.config.effective_exit_band()                                                                                                                                                                                                                       
      217 +    }                                                                                                                                                                                                                                                                                                  
      218 +                                                                                                                                                                                                                                                                                                       
      219 +    /// Check if we should enter short.                                                                                                                                                                                                                                                                
      220 +    fn should_enter_short(&self) -> bool {                                                                                                                                                                                                                                                             
      221 +        self.current_funding_rate_mantissa > self.config.threshold_mantissa                                                                                                                                                                                                                            
      222 +    }                                                                                                                                                                                                                                                                                                  
      223 +                                                                                                                                                                                                                                                                                                       
      224 +    /// Check if we should enter long.                                                                                                                                                                                                                                                                 
      225 +    fn should_enter_long(&self) -> bool {                                                                                                                                                                                                                                                              
      226 +        self.current_funding_rate_mantissa < -self.config.threshold_mantissa                                                                                                                                                                                                                           
      227 +    }                                                                                                                                                                                                                                                                                                  
      228 +                                                                                                                                                                                                                                                                                                       
      229 +    /// Check current position state.                                                                                                                                                                                                                                                                  
      230 +    fn is_long(&self) -> bool {                                                                                                                                                                                                                                                                        
      231 +        self.position_qty_mantissa > 0                                                                                                                                                                                                                                                                 
      232 +    }                                                                                                                                                                                                                                                                                                  
      233 +                                                                                                                                                                                                                                                                                                       
      234 +    fn is_short(&self) -> bool {                                                                                                                                                                                                                                                                       
      235 +        self.position_qty_mantissa < 0                                                                                                                                                                                                                                                                 
      236 +    }                                                                                                                                                                                                                                                                                                  
      237 +                                                                                                                                                                                                                                                                                                       
      238 +    fn is_flat(&self) -> bool {                                                                                                                                                                                                                                                                        
      239 +        self.position_qty_mantissa == 0                                                                                                                                                                                                                                                                
      240 +    }                                                                                                                                                                                                                                                                                                  
      241  }                                                                                                                                                                                                                                                                                                      
      242                                                                                                                                                                                                                                                                                                         
      243  impl Strategy for FundingBiasStrategy {                                                                                                                                                                                                                                                                
     ...                                                                                                                                                                                                                                                                                                          
      222          // Update funding rate from Funding events                                                                                                                                                                                                                                                     
      223          // Data format: funding_rate_mantissa + rate_exponent (canonical integer format)                                                                                                                                                                                                               
      224          if event.kind == EventKind::Funding {                                                                                                                                                                                                                                                          
      225 -            if let Some(rate_mantissa) = event.payload.get("funding_rate_mantissa").and_then(|v| v.as_i64()) {                                                                                                                                                                                         
      226 -                let rate_exponent = event.payload                                                                                                                                                                                                                                                      
      225 +            if let Some(rate_mantissa) =                                                                                                                                                                                                                                                               
      226 +                event.payload.get("funding_rate_mantissa").and_then(|v| v.as_i64())                                                                                                                                                                                                                    
      227 +            {                                                                                                                                                                                                                                                                                          
      228 +                let rate_exponent = event                                                                                                                                                                                                                                                              
      229 +                    .payload                                                                                                                                                                                                                                                                           
      230                      .get("rate_exponent")                                                                                                                                                                                                                                                              
      231                      .and_then(|v| v.as_i64())                                                                                                                                                                                                                                                          
      232                      .unwrap_or(-8) as i8;                                                                                                                                                                                                                                                              
      233                                                                                                                                                                                                                                                                                                         
      234                  // Convert to our threshold exponent for comparison                                                                                                                                                                                                                                    
      235 -                // rate_mantissa * 10^rate_exponent = our_mantissa * 10^threshold_exponent                                                                                                                                                                                                             
      236 -                // our_mantissa = rate_mantissa * 10^(rate_exponent - threshold_exponent)                                                                                                                                                                                                              
      235                  let exp_diff = rate_exponent as i32 - self.config.threshold_exponent as i32;                                                                                                                                                                                                           
      236                  self.current_funding_rate_mantissa = if exp_diff >= 0 {                                                                                                                                                                                                                                
      237                      rate_mantissa * 10i64.pow(exp_diff as u32)                                                                                                                                                                                                                                         
     ...                                                                                                                                                                                                                                                                                                          
      240              }                                                                                                                                                                                                                                                                                          
      241          }                                                                                                                                                                                                                                                                                              
      242                                                                                                                                                                                                                                                                                                         
      243 -        // Only trade on perp price updates (need prices)                                                                                                                                                                                                                                              
      243 +        // Only trade on perp price updates (need prices for execution)                                                                                                                                                                                                                                
      244          if !matches!(event.kind, EventKind::PerpQuote | EventKind::PerpDepth) {                                                                                                                                                                                                                        
      245              return vec![];                                                                                                                                                                                                                                                                             
      246          }                                                                                                                                                                                                                                                                                              
      247                                                                                                                                                                                                                                                                                                         
      248          let mut outputs = vec![];                                                                                                                                                                                                                                                                      
      249                                                                                                                                                                                                                                                                                                         
      250 -        // Strategy logic: trade based on funding rate direction                                                                                                                                                                                                                                       
      251 -        // - Funding positive & not short → go short (shorts receive funding)                                                                                                                                                                                                                          
      252 -        // - Funding negative & not long → go long (longs receive funding)                                                                                                                                                                                                                             
      250 +        // =================================================================                                                                                                                                                                                                                           
      251 +        // PHASE 27.1: Complete entry/exit/flip logic                                                                                                                                                                                                                                                  
      252 +        // =================================================================                                                                                                                                                                                                                           
      253                                                                                                                                                                                                                                                                                                         
      254 -        if self.current_funding_rate_mantissa > self.config.threshold_mantissa                                                                                                                                                                                                                         
      255 -            && self.position_qty_mantissa >= 0                                                                                                                                                                                                                                                         
      256 -        {                                                                                                                                                                                                                                                                                              
      257 -            // Funding positive, go short                                                                                                                                                                                                                                                              
      258 -            let decision = self.create_decision(ctx, -1, "entry", "funding_short");                                                                                                                                                                                                                    
      259 -            let intent = self.create_intent(decision.decision_id, ctx, Side::Sell, "funding_short");                                                                                                                                                                                                   
      260 -            outputs.push(DecisionOutput::new(decision, intent));                                                                                                                                                                                                                                       
      261 -        } else if self.current_funding_rate_mantissa < -self.config.threshold_mantissa                                                                                                                                                                                                                 
      262 -            && self.position_qty_mantissa <= 0                                                                                                                                                                                                                                                         
      263 -        {                                                                                                                                                                                                                                                                                              
      264 -            // Funding negative, go long                                                                                                                                                                                                                                                               
      265 -            let decision = self.create_decision(ctx, 1, "entry", "funding_long");                                                                                                                                                                                                                      
      266 -            let intent = self.create_intent(decision.decision_id, ctx, Side::Buy, "funding_long");                                                                                                                                                                                                     
      267 -            outputs.push(DecisionOutput::new(decision, intent));                                                                                                                                                                                                                                       
      254 +        if self.is_long() {                                                                                                                                                                                                                                                                            
      255 +            // Currently LONG - check for exit or flip to short                                                                                                                                                                                                                                        
      256 +            if self.should_enter_short() {                                                                                                                                                                                                                                                             
      257 +                // FLIP: exit long + enter short (two decisions, stable order)                                                                                                                                                                                                                         
      258 +                let exit_decision = self.create_decision(ctx, 0, "exit", "exit_long");                                                                                                                                                                                                                 
      259 +                let exit_intent =                                                                                                                                                                                                                                                                      
      260 +                    self.create_intent(exit_decision.decision_id, ctx, Side::Sell, "exit_long");                                                                                                                                                                                                       
      261 +                outputs.push(DecisionOutput::new(exit_decision, exit_intent));                                                                                                                                                                                                                         
      262 +                                                                                                                                                                                                                                                                                                       
      263 +                let entry_decision = self.create_decision(ctx, -1, "entry", "entry_short");                                                                                                                                                                                                            
      264 +                let entry_intent =                                                                                                                                                                                                                                                                     
      265 +                    self.create_intent(entry_decision.decision_id, ctx, Side::Sell, "entry_short");                                                                                                                                                                                                    
      266 +                outputs.push(DecisionOutput::new(entry_decision, entry_intent));                                                                                                                                                                                                                       
      267 +            } else if self.should_exit_long() {                                                                                                                                                                                                                                                        
      268 +                // EXIT LONG only (funding reverted inside hysteresis band)                                                                                                                                                                                                                            
      269 +                let decision = self.create_decision(ctx, 0, "exit", "exit_long");                                                                                                                                                                                                                      
      270 +                let intent = self.create_intent(decision.decision_id, ctx, Side::Sell, "exit_long");                                                                                                                                                                                                   
      271 +                outputs.push(DecisionOutput::new(decision, intent));                                                                                                                                                                                                                                   
      272 +            }                                                                                                                                                                                                                                                                                          
      273 +        } else if self.is_short() {                                                                                                                                                                                                                                                                    
      274 +            // Currently SHORT - check for exit or flip to long                                                                                                                                                                                                                                        
      275 +            if self.should_enter_long() {                                                                                                                                                                                                                                                              
      276 +                // FLIP: exit short + enter long (two decisions, stable order)                                                                                                                                                                                                                         
      277 +                let exit_decision = self.create_decision(ctx, 0, "exit", "exit_short");                                                                                                                                                                                                                
      278 +                let exit_intent =                                                                                                                                                                                                                                                                      
      279 +                    self.create_intent(exit_decision.decision_id, ctx, Side::Buy, "exit_short");                                                                                                                                                                                                       
      280 +                outputs.push(DecisionOutput::new(exit_decision, exit_intent));                                                                                                                                                                                                                         
      281 +                                                                                                                                                                                                                                                                                                       
      282 +                let entry_decision = self.create_decision(ctx, 1, "entry", "entry_long");                                                                                                                                                                                                              
      283 +                let entry_intent =                                                                                                                                                                                                                                                                     
      284 +                    self.create_intent(entry_decision.decision_id, ctx, Side::Buy, "entry_long");                                                                                                                                                                                                      
      285 +                outputs.push(DecisionOutput::new(entry_decision, entry_intent));                                                                                                                                                                                                                       
      286 +            } else if self.should_exit_short() {                                                                                                                                                                                                                                                       
      287 +                // EXIT SHORT only (funding reverted inside hysteresis band)                                                                                                                                                                                                                           
      288 +                let decision = self.create_decision(ctx, 0, "exit", "exit_short");                                                                                                                                                                                                                     
      289 +                let intent = self.create_intent(decision.decision_id, ctx, Side::Buy, "exit_short");                                                                                                                                                                                                   
      290 +                outputs.push(DecisionOutput::new(decision, intent));                                                                                                                                                                                                                                   
      291 +            }                                                                                                                                                                                                                                                                                          
      292 +        } else {                                                                                                                                                                                                                                                                                       
      293 +            // Currently FLAT - check for new entry                                                                                                                                                                                                                                                    
      294 +            if self.should_enter_short() {                                                                                                                                                                                                                                                             
      295 +                // ENTER SHORT (funding positive, shorts receive funding)                                                                                                                                                                                                                              
      296 +                let decision = self.create_decision(ctx, -1, "entry", "entry_short");                                                                                                                                                                                                                  
      297 +                let intent =                                                                                                                                                                                                                                                                           
      298 +                    self.create_intent(decision.decision_id, ctx, Side::Sell, "entry_short");                                                                                                                                                                                                          
      299 +                outputs.push(DecisionOutput::new(decision, intent));                                                                                                                                                                                                                                   
      300 +            } else if self.should_enter_long() {                                                                                                                                                                                                                                                       
      301 +                // ENTER LONG (funding negative, longs receive funding)                                                                                                                                                                                                                                
      302 +                let decision = self.create_decision(ctx, 1, "entry", "entry_long");                                                                                                                                                                                                                    
      303 +                let intent =                                                                                                                                                                                                                                                                           
      304 +                    self.create_intent(decision.decision_id, ctx, Side::Buy, "entry_long");                                                                                                                                                                                                            
      305 +                outputs.push(DecisionOutput::new(decision, intent));                                                                                                                                                                                                                                   
      306 +            }                                                                                                                                                                                                                                                                                          
      307          }                                                                                                                                                                                                                                                                                              
      308                                                                                                                                                                                                                                                                                                         
      309          outputs                                                                                                                                                                                                                                                                                        
     ...                                                                                                                                                                                                                                                                                                          
      335      }                                                                                                                                                                                                                                                                                                  
      336                                                                                                                                                                                                                                                                                                         
      337      #[test]                                                                                                                                                                                                                                                                                            
      338 +    fn test_effective_exit_band() {                                                                                                                                                                                                                                                                    
      339 +        let config = FundingBiasConfig {                                                                                                                                                                                                                                                               
      340 +            threshold_mantissa: 100,                                                                                                                                                                                                                                                                   
      341 +            exit_band_mantissa: None,                                                                                                                                                                                                                                                                  
      342 +            ..FundingBiasConfig::default()                                                                                                                                                                                                                                                             
      343 +        };                                                                                                                                                                                                                                                                                             
      344 +        assert_eq!(config.effective_exit_band(), 50); // threshold / 2                                                                                                                                                                                                                                 
      345 +                                                                                                                                                                                                                                                                                                       
      346 +        let config2 = FundingBiasConfig {                                                                                                                                                                                                                                                              
      347 +            threshold_mantissa: 100,                                                                                                                                                                                                                                                                   
      348 +            exit_band_mantissa: Some(30),                                                                                                                                                                                                                                                              
      349 +            ..FundingBiasConfig::default()                                                                                                                                                                                                                                                             
      350 +        };                                                                                                                                                                                                                                                                                             
      351 +        assert_eq!(config2.effective_exit_band(), 30); // explicit override                                                                                                                                                                                                                            
      352 +    }                                                                                                                                                                                                                                                                                                  
      353 +                                                                                                                                                                                                                                                                                                       
      354 +    #[test]                                                                                                                                                                                                                                                                                            
      355      fn test_strategy_id_format() {                                                                                                                                                                                                                                                                     
      356          let strategy = FundingBiasStrategy::new(FundingBiasConfig::default());                                                                                                                                                                                                                         
      357          let id = strategy.strategy_id();                                                                                                                                                                                                                                                               
     ...                                                                                                                                                                                                                                                                                                          
      359      }                                                                                                                                                                                                                                                                                                  
      360                                                                                                                                                                                                                                                                                                         
      361      #[test]                                                                                                                                                                                                                                                                                            
      362 -    fn test_strategy_returns_decision_output() {                                                                                                                                                                                                                                                       
      362 +    fn test_entry_short_when_funding_positive() {                                                                                                                                                                                                                                                      
      363          let mut strategy = FundingBiasStrategy::new(FundingBiasConfig::default());                                                                                                                                                                                                                     
      364                                                                                                                                                                                                                                                                                                         
      365 -        // Set high funding rate to trigger short                                                                                                                                                                                                                                                      
      365 +        // Set high funding rate to trigger short entry                                                                                                                                                                                                                                                
      366          strategy.current_funding_rate_mantissa = 200; // Above threshold of 100                                                                                                                                                                                                                        
      367                                                                                                                                                                                                                                                                                                         
      368          let market = make_test_market();                                                                                                                                                                                                                                                               
     ...                                                                                                                                                                                                                                                                                                          
      382                                                                                                                                                                                                                                                                                                         
      383          let outputs = strategy.on_event(&event, &ctx);                                                                                                                                                                                                                                                 
      384                                                                                                                                                                                                                                                                                                         
      385 -        // Should have one output (short signal)                                                                                                                                                                                                                                                       
      385          assert_eq!(outputs.len(), 1);                                                                                                                                                                                                                                                                  
      386          let output = &outputs[0];                                                                                                                                                                                                                                                                      
      387 -                                                                                                                                                                                                                                                                                                       
      388 -        // Decision should be authored                                                                                                                                                                                                                                                                 
      387          assert_eq!(output.decision.direction, -1); // Short                                                                                                                                                                                                                                            
      388          assert_eq!(output.decision.decision_type, "entry");                                                                                                                                                                                                                                            
      389 -        assert!(output.decision.strategy_id.starts_with(FUNDING_BIAS_NAME));                                                                                                                                                                                                                           
      390 -                                                                                                                                                                                                                                                                                                       
      391 -        // Intent should match decision                                                                                                                                                                                                                                                                
      392 -        assert_eq!(output.intents.len(), 1);                                                                                                                                                                                                                                                           
      389          assert_eq!(output.intents[0].side, Side::Sell);                                                                                                                                                                                                                                                
      390 -        assert_eq!(output.intents[0].tag, Some("funding_short".to_string()));                                                                                                                                                                                                                          
      390 +        assert_eq!(output.intents[0].tag, Some("entry_short".to_string()));                                                                                                                                                                                                                            
      391      }                                                                                                                                                                                                                                                                                                  
      392                                                                                                                                                                                                                                                                                                         
      393      #[test]                                                                                                                                                                                                                                                                                            
      394 -    fn test_strategy_no_signal_below_threshold() {                                                                                                                                                                                                                                                     
      394 +    fn test_exit_short_when_funding_reverts() {                                                                                                                                                                                                                                                        
      395          let mut strategy = FundingBiasStrategy::new(FundingBiasConfig::default());                                                                                                                                                                                                                     
      396                                                                                                                                                                                                                                                                                                         
      397 -        // Funding rate below threshold                                                                                                                                                                                                                                                                
      398 -        strategy.current_funding_rate_mantissa = 50; // Below threshold of 100                                                                                                                                                                                                                         
      397 +        // Simulate existing short position                                                                                                                                                                                                                                                            
      398 +        strategy.position_qty_mantissa = -1_000_000;                                                                                                                                                                                                                                                   
      399 +        // Funding reverted inside exit band (threshold=100, exit_band=50)                                                                                                                                                                                                                             
      400 +        strategy.current_funding_rate_mantissa = -60; // Below -exit_band (-50)                                                                                                                                                                                                                        
      401                                                                                                                                                                                                                                                                                                         
      402          let market = make_test_market();                                                                                                                                                                                                                                                               
      403          let ctx = StrategyContext {                                                                                                                                                                                                                                                                    
     ...                                                                                                                                                                                                                                                                                                          
      421                                                                                                                                                                                                                                                                                                         
      422          let outputs = strategy.on_event(&event, &ctx);                                                                                                                                                                                                                                                 
      423                                                                                                                                                                                                                                                                                                         
      424 -        // Should have no output (no signal)                                                                                                                                                                                                                                                           
      424 +        assert_eq!(outputs.len(), 1);                                                                                                                                                                                                                                                                  
      425 +        let output = &outputs[0];                                                                                                                                                                                                                                                                      
      426 +        assert_eq!(output.decision.decision_type, "exit");                                                                                                                                                                                                                                             
      427 +        assert_eq!(output.intents[0].side, Side::Buy); // Buy to close short                                                                                                                                                                                                                           
      428 +        assert_eq!(output.intents[0].tag, Some("exit_short".to_string()));                                                                                                                                                                                                                             
      429 +    }                                                                                                                                                                                                                                                                                                  
      430 +                                                                                                                                                                                                                                                                                                       
      431 +    #[test]                                                                                                                                                                                                                                                                                            
      432 +    fn test_flip_long_to_short() {                                                                                                                                                                                                                                                                     
      433 +        let mut strategy = FundingBiasStrategy::new(FundingBiasConfig::default());                                                                                                                                                                                                                     
      434 +                                                                                                                                                                                                                                                                                                       
      435 +        // Simulate existing long position                                                                                                                                                                                                                                                             
      436 +        strategy.position_qty_mantissa = 1_000_000;                                                                                                                                                                                                                                                    
      437 +        // Funding flipped to strongly positive (crosses entry threshold for short)                                                                                                                                                                                                                    
      438 +        strategy.current_funding_rate_mantissa = 200; // Above +threshold                                                                                                                                                                                                                              
      439 +                                                                                                                                                                                                                                                                                                       
      440 +        let market = make_test_market();                                                                                                                                                                                                                                                               
      441 +        let ctx = StrategyContext {                                                                                                                                                                                                                                                                    
      442 +            ts: Utc::now(),                                                                                                                                                                                                                                                                            
      443 +            run_id: "test-run",                                                                                                                                                                                                                                                                        
      444 +            symbol: "BTCUSDT",                                                                                                                                                                                                                                                                         
      445 +            market: &market,                                                                                                                                                                                                                                                                           
      446 +        };                                                                                                                                                                                                                                                                                             
      447 +                                                                                                                                                                                                                                                                                                       
      448 +        let event = ReplayEvent {                                                                                                                                                                                                                                                                      
      449 +            ts: Utc::now(),                                                                                                                                                                                                                                                                            
      450 +            symbol: "BTCUSDT".to_string(),                                                                                                                                                                                                                                                             
      451 +            kind: EventKind::PerpQuote,                                                                                                                                                                                                                                                                
      452 +            payload: serde_json::json!({}),                                                                                                                                                                                                                                                            
      453 +        };                                                                                                                                                                                                                                                                                             
      454 +                                                                                                                                                                                                                                                                                                       
      455 +        let outputs = strategy.on_event(&event, &ctx);                                                                                                                                                                                                                                                 
      456 +                                                                                                                                                                                                                                                                                                       
      457 +        // Should have 2 outputs: exit_long + entry_short                                                                                                                                                                                                                                              
      458 +        assert_eq!(outputs.len(), 2);                                                                                                                                                                                                                                                                  
      459 +                                                                                                                                                                                                                                                                                                       
      460 +        // First: exit long                                                                                                                                                                                                                                                                            
      461 +        assert_eq!(outputs[0].decision.decision_type, "exit");                                                                                                                                                                                                                                         
      462 +        assert_eq!(outputs[0].intents[0].tag, Some("exit_long".to_string()));                                                                                                                                                                                                                          
      463 +                                                                                                                                                                                                                                                                                                       
      464 +        // Second: enter short                                                                                                                                                                                                                                                                         
      465 +        assert_eq!(outputs[1].decision.decision_type, "entry");                                                                                                                                                                                                                                        
      466 +        assert_eq!(outputs[1].intents[0].tag, Some("entry_short".to_string()));                                                                                                                                                                                                                        
      467 +    }                                                                                                                                                                                                                                                                                                  
      468 +                                                                                                                                                                                                                                                                                                       
      469 +    #[test]                                                                                                                                                                                                                                                                                            
      470 +    fn test_no_signal_in_neutral_zone() {                                                                                                                                                                                                                                                              
      471 +        let mut strategy = FundingBiasStrategy::new(FundingBiasConfig::default());                                                                                                                                                                                                                     
      472 +                                                                                                                                                                                                                                                                                                       
      473 +        // Funding rate in neutral zone (between exit_band and threshold)                                                                                                                                                                                                                              
      474 +        strategy.current_funding_rate_mantissa = 60; // Above exit_band (50) but below threshold (100)                                                                                                                                                                                                 
      475 +                                                                                                                                                                                                                                                                                                       
      476 +        let market = make_test_market();                                                                                                                                                                                                                                                               
      477 +        let ctx = StrategyContext {                                                                                                                                                                                                                                                                    
      478 +            ts: Utc::now(),                                                                                                                                                                                                                                                                            
      479 +            run_id: "test-run",                                                                                                                                                                                                                                                                        
      480 +            symbol: "BTCUSDT",                                                                                                                                                                                                                                                                         
      481 +            market: &market,                                                                                                                                                                                                                                                                           
      482 +        };                                                                                                                                                                                                                                                                                             
      483 +                                                                                                                                                                                                                                                                                                       
      484 +        let event = ReplayEvent {                                                                                                                                                                                                                                                                      
      485 +            ts: Utc::now(),                                                                                                                                                                                                                                                                            
      486 +            symbol: "BTCUSDT".to_string(),                                                                                                                                                                                                                                                             
      487 +            kind: EventKind::PerpQuote,                                                                                                                                                                                                                                                                
      488 +            payload: serde_json::json!({}),                                                                                                                                                                                                                                                            
      489 +        };                                                                                                                                                                                                                                                                                             
      490 +                                                                                                                                                                                                                                                                                                       
      491 +        let outputs = strategy.on_event(&event, &ctx);                                                                                                                                                                                                                                                 
      492 +                                                                                                                                                                                                                                                                                                       
      493 +        // Should have no output (neutral zone)                                                                                                                                                                                                                                                        
      494          assert!(outputs.is_empty());                                                                                                                                                                                                                                                                   
      495      }                                                                                                                                                                                                                                                                                                  
      496                                                                                                                                                                                                                                                                                                         
     ...                                                                                                                                                                                                                                                                                                          
      437              market: &market,                                                                                                                                                                                                                                                                           
      438          };                                                                                                                                                                                                                                                                                             
      439                                                                                                                                                                                                                                                                                                         
      440 -        // Buy fill                                                                                                                                                                                                                                                                                    
      440 +        // Buy fill (entry long)                                                                                                                                                                                                                                                                       
      441          let fill = FillNotification {                                                                                                                                                                                                                                                                  
      442              ts: Utc::now(),                                                                                                                                                                                                                                                                            
      443              symbol: "BTCUSDT".to_string(),                                                                                                                                                                                                                                                             
     ...                                                                                                                                                                                                                                                                                                          
      448              price_exponent: -2,                                                                                                                                                                                                                                                                        
      449              fee_mantissa: 1000,                                                                                                                                                                                                                                                                        
      450              fee_exponent: -8,                                                                                                                                                                                                                                                                          
      451 -            tag: Some("funding_long".to_string()),                                                                                                                                                                                                                                                     
      451 +            tag: Some("entry_long".to_string()),                                                                                                                                                                                                                                                       
      452          };                                                                                                                                                                                                                                                                                             
      453                                                                                                                                                                                                                                                                                                         
      454          strategy.on_fill(&fill, &ctx);                                                                                                                                                                                                                                                                 
      455          assert_eq!(strategy.position_qty_mantissa, 1_000_000);                                                                                                                                                                                                                                         
      456 +        assert!(strategy.is_long());                                                                                                                                                                                                                                                                   
      457                                                                                                                                                                                                                                                                                                         
      458 -        // Sell fill                                                                                                                                                                                                                                                                                   
      458 +        // Sell fill (exit long)                                                                                                                                                                                                                                                                       
      459          let fill2 = FillNotification {                                                                                                                                                                                                                                                                 
      460              side: Side::Sell,                                                                                                                                                                                                                                                                          
      461 -            qty_mantissa: 500_000,                                                                                                                                                                                                                                                                     
      461 +            qty_mantissa: 1_000_000,                                                                                                                                                                                                                                                                   
      462 +            tag: Some("exit_long".to_string()),                                                                                                                                                                                                                                                        
      463              ..fill                                                                                                                                                                                                                                                                                     
      464          };                                                                                                                                                                                                                                                                                             
      465                                                                                                                                                                                                                                                                                                         
      466          strategy.on_fill(&fill2, &ctx);                                                                                                                                                                                                                                                                
      467 -        assert_eq!(strategy.position_qty_mantissa, 500_000);                                                                                                                                                                                                                                           
      467 +        assert_eq!(strategy.position_qty_mantissa, 0);                                                                                                                                                                                                                                                 
      468 +        assert!(strategy.is_flat());                                                                                                                                                                                                                                                                   
      469      }                                                                                                                                                                                                                                                                                                  
      470  }                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                  
● Now update the config file with the new exit_band field.                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                  
● Write(configs/strategies/funding_bias_phase27.toml)                                                                                                                                                                                                                                                             
  ⎿  Added 8 lines, removed 4 lines                                                                                                                                                                                                                                                                               
       1 -# FundingBias Strategy Config - Phase 27 Testing                                                                                                                                                                                                                                                        
       2 -# Lowered threshold to match actual funding rate range in segment                                                                                                                                                                                                                                       
       1 +# FundingBias Strategy Config - Phase 27.1 Testing                                                                                                                                                                                                                                                      
       2 +# v2.1.0 with exit logic + hysteresis                                                                                                                                                                                                                                                                   
       3                                                                                                                                                                                                                                                                                                          
       4 -# Threshold: 50 with exp -6 = 0.00005 = 5 basis points                                                                                                                                                                                                                                                  
       5 -# (Segment has funding rates ~2-8 bps)                                                                                                                                                                                                                                                                  
       4 +# Entry threshold: 50 with exp -6 = 5 basis points                                                                                                                                                                                                                                                      
       5 +# (Segment funding rates range ~2-8 bps)                                                                                                                                                                                                                                                                
       6  threshold_mantissa = 50                                                                                                                                                                                                                                                                                 
       7  threshold_exponent = -6                                                                                                                                                                                                                                                                                 
       8                                                                                                                                                                                                                                                                                                          
       9 +# Exit band: 25 with exp -6 = 2.5 basis points (threshold / 2)                                                                                                                                                                                                                                          
      10 +# Exit when funding reverts inside this band                                                                                                                                                                                                                                                            
      11 +exit_band_mantissa = 25                                                                                                                                                                                                                                                                                 
      12 +                                                                                                                                                                                                                                                                                                        
      13  # Position size: 0.01 BTC                                                                                                                                                                                                                                                                               
      14  position_size_mantissa = 1_000_000                                                                                                                                                                                                                                                                      
      15  qty_exponent = -8                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                  
● Bash(cargo build --release -p quantlaxmi-runner-crypto 2>&1) timeout: 3m 0s                                                                                                                                                                                                                                     
  ⎿     Compiling quantlaxmi-strategy v0.1.0 (/home/isoula/7hills/QuantLaxmi/crates/quantlaxmi-strategy)                                                                                                                                                                                                          
     warning: method `is_flat` is never used                                                                                                                                                                                                                                                                      
        --> crates/quantlaxmi-strategy/src/strategies/funding_bias.rs:263:8                                                                                                                                                                                                                                       
     … +12 lines (ctrl+o to expand)                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                  
● Build successful. Running Phase 27.2 with the evaluable funding_bias v2.1.0.                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                  
  Run A: latency_ticks=0                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                  
● Bash(/home/isoula/7hills/QuantLaxmi/target/release/quantlaxmi-crypto backtest --segment-dir /home/isoula/7hills/QuantLaxmi/data/perp_sessions/perp_20260125_133424 --…) timeout: 5m 0s                                                                                                                          
  ⎿  2026-01-29T04:26:18.974788Z  WARN ⚠️  PROMOTION ENFORCEMENT DISABLED - Running in dev mode. Production deployments MUST set --require-promotion to enforce signal promotion status.                                                                                                                           
                                                                                                                                                                                                                                                                                                                  
     ================================================================================                                                                                                                                                                                                                             
     … +49 lines (ctrl+o to expand)                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                  
● Hmm, still 0 trades. The issue: funding is always positive (22-82 in exp -6 terms), so the exit condition funding <= -exit_band is never met.                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                  
  Let me check the data range again and fix the exit logic to work with unidirectional funding.                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                  
● Bash(jq -r '.funding_rate_mantissa' /home/isoula/7hills/QuantLaxmi/data/perp_sessions/perp_20260125_133424/BTCUSDT/funding.jsonl | awk '{sum+=$1; count++} END {print…) timeout: 1m 0s                                                                                                                          
  ⎿  Min: 4919.79 Count: 17816                                                                                                                                                                                                                                                                                    
          41 2245                                                                                                                                                                                                                                                                                                 
          19 2257                                                                                                                                                                                                                                                                                                 
     … +18 lines (ctrl+o to expand)                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                  
● Funding is always positive (never negative). Current exit logic expects funding to cross zero, which never happens.                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                  
  Fixing exit logic to be economically sensible: exit when funding loses its edge (drops below threshold), not when it reverses sign.                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                  
● Update(crates/quantlaxmi-strategy/src/strategies/funding_bias.rs)                                                                                                                                                                                                                                               
  ⎿  Added 6 lines, removed 4 lines                                                                                                                                                                                                                                                                               
      231                                                                                                                                                                                                                                                                                                         
      232      /// Check if we should exit a long position.                                                                                                                                                                                                                                                       
      233      fn should_exit_long(&self) -> bool {                                                                                                                                                                                                                                                               
      234 -        // Exit long when funding reverts toward positive (above exit band)                                                                                                                                                                                                                            
      235 -        self.current_funding_rate_mantissa >= self.config.effective_exit_band()                                                                                                                                                                                                                        
      234 +        // Exit long when funding rises above -exit_band (lost negative edge)                                                                                                                                                                                                                          
      235 +        // Long entry requires funding < -threshold; exit when funding > -exit_band                                                                                                                                                                                                                    
      236 +        self.current_funding_rate_mantissa > -self.config.effective_exit_band()                                                                                                                                                                                                                        
      237      }                                                                                                                                                                                                                                                                                                  
      238                                                                                                                                                                                                                                                                                                         
      239      /// Check if we should exit a short position.                                                                                                                                                                                                                                                      
      240      fn should_exit_short(&self) -> bool {                                                                                                                                                                                                                                                              
      241 -        // Exit short when funding reverts toward negative (below -exit band)                                                                                                                                                                                                                          
      242 -        self.current_funding_rate_mantissa <= -self.config.effective_exit_band()                                                                                                                                                                                                                       
      241 +        // Exit short when funding drops below +exit_band (lost positive edge)                                                                                                                                                                                                                         
      242 +        // Short entry requires funding > +threshold; exit when funding < +exit_band                                                                                                                                                                                                                   
      243 +        self.current_funding_rate_mantissa < self.config.effective_exit_band()                                                                                                                                                                                                                         
      244      }                                                                                                                                                                                                                                                                                                  
      245                                                                                                                                                                                                                                                                                                         
      246      /// Check if we should enter short.                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                  
● Also need to fix the test that expects the old logic.                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                  
● Update(crates/quantlaxmi-strategy/src/strategies/funding_bias.rs)                                                                                                                                                                                                                                               
  ⎿  Added 4 lines, removed 3 lines                                                                                                                                                                                                                                                                               
      510      }                                                                                                                                                                                                                                                                                                  
      511                                                                                                                                                                                                                                                                                                         
      512      #[test]                                                                                                                                                                                                                                                                                            
      513 -    fn test_exit_short_when_funding_reverts() {                                                                                                                                                                                                                                                        
      513 +    fn test_exit_short_when_funding_drops() {                                                                                                                                                                                                                                                          
      514          let mut strategy = FundingBiasStrategy::new(FundingBiasConfig::default());                                                                                                                                                                                                                     
      515                                                                                                                                                                                                                                                                                                         
      516          // Simulate existing short position                                                                                                                                                                                                                                                            
      517          strategy.position_qty_mantissa = -1_000_000;                                                                                                                                                                                                                                                   
      518 -        // Funding reverted inside exit band (threshold=100, exit_band=50)                                                                                                                                                                                                                             
      519 -        strategy.current_funding_rate_mantissa = -60; // Below -exit_band (-50)                                                                                                                                                                                                                        
      518 +        // Funding dropped below exit band (threshold=100, exit_band=50)                                                                                                                                                                                                                               
      519 +        // Short was entered when funding > 100, now funding < 50 (lost edge)                                                                                                                                                                                                                          
      520 +        strategy.current_funding_rate_mantissa = 40; // Below exit_band (50)                                                                                                                                                                                                                           
      521                                                                                                                                                                                                                                                                                                         
      522          let market = make_test_market();                                                                                                                                                                                                                                                               
      523          let ctx = StrategyContext {                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                  
● Update(crates/quantlaxmi-strategy/src/strategies/funding_bias.rs)                                                                                                                                                                                                                                               
  ⎿  Added 32 lines, removed 2 lines                                                                                                                                                                                                                                                                              
      582      }                                                                                                                                                                                                                                                                                                  
      583                                                                                                                                                                                                                                                                                                         
      584      #[test]                                                                                                                                                                                                                                                                                            
      585 -    fn test_no_signal_in_neutral_zone() {                                                                                                                                                                                                                                                              
      585 +    fn test_no_signal_in_neutral_zone_when_flat() {                                                                                                                                                                                                                                                    
      586          let mut strategy = FundingBiasStrategy::new(FundingBiasConfig::default());                                                                                                                                                                                                                     
      587                                                                                                                                                                                                                                                                                                         
      588          // Funding rate in neutral zone (between exit_band and threshold)                                                                                                                                                                                                                              
      589 +        // When flat, no entry (threshold=100 not crossed), no exit (no position)                                                                                                                                                                                                                      
      590          strategy.current_funding_rate_mantissa = 60; // Above exit_band (50) but below threshold (100)                                                                                                                                                                                                 
      591                                                                                                                                                                                                                                                                                                         
      592          let market = make_test_market();                                                                                                                                                                                                                                                               
     ...                                                                                                                                                                                                                                                                                                          
      605                                                                                                                                                                                                                                                                                                         
      606          let outputs = strategy.on_event(&event, &ctx);                                                                                                                                                                                                                                                 
      607                                                                                                                                                                                                                                                                                                         
      608 -        // Should have no output (neutral zone)                                                                                                                                                                                                                                                        
      608 +        // Should have no output (neutral zone, no position)                                                                                                                                                                                                                                           
      609          assert!(outputs.is_empty());                                                                                                                                                                                                                                                                   
      610      }                                                                                                                                                                                                                                                                                                  
      611                                                                                                                                                                                                                                                                                                         
      612      #[test]                                                                                                                                                                                                                                                                                            
      613 +    fn test_hold_short_in_hysteresis_zone() {                                                                                                                                                                                                                                                          
      614 +        let mut strategy = FundingBiasStrategy::new(FundingBiasConfig::default());                                                                                                                                                                                                                     
      615 +                                                                                                                                                                                                                                                                                                       
      616 +        // Have a short position, funding in hysteresis zone (above exit_band, below threshold)                                                                                                                                                                                                        
      617 +        strategy.position_qty_mantissa = -1_000_000;                                                                                                                                                                                                                                                   
      618 +        strategy.current_funding_rate_mantissa = 70; // Above exit_band (50), below threshold (100)                                                                                                                                                                                                    
      619 +                                                                                                                                                                                                                                                                                                       
      620 +        let market = make_test_market();                                                                                                                                                                                                                                                               
      621 +        let ctx = StrategyContext {                                                                                                                                                                                                                                                                    
      622 +            ts: Utc::now(),                                                                                                                                                                                                                                                                            
      623 +            run_id: "test-run",                                                                                                                                                                                                                                                                        
      624 +            symbol: "BTCUSDT",                                                                                                                                                                                                                                                                         
      625 +            market: &market,                                                                                                                                                                                                                                                                           
      626 +        };                                                                                                                                                                                                                                                                                             
      627 +                                                                                                                                                                                                                                                                                                       
      628 +        let event = ReplayEvent {                                                                                                                                                                                                                                                                      
      629 +            ts: Utc::now(),                                                                                                                                                                                                                                                                            
      630 +            symbol: "BTCUSDT".to_string(),                                                                                                                                                                                                                                                             
      631 +            kind: EventKind::PerpQuote,                                                                                                                                                                                                                                                                
      632 +            payload: serde_json::json!({}),                                                                                                                                                                                                                                                            
      633 +        };                                                                                                                                                                                                                                                                                             
      634 +                                                                                                                                                                                                                                                                                                       
      635 +        let outputs = strategy.on_event(&event, &ctx);                                                                                                                                                                                                                                                 
      636 +                                                                                                                                                                                                                                                                                                       
      637 +        // Should hold position (in hysteresis zone - above exit_band, so no exit)                                                                                                                                                                                                                     
      638 +        assert!(outputs.is_empty());                                                                                                                                                                                                                                                                   
      639 +    }                                                                                                                                                                                                                                                                                                  
      640 +                                                                                                                                                                                                                                                                                                       
      641 +    #[test]                                                                                                                                                                                                                                                                                            
      642      fn test_on_fill_updates_position() {                                                                                                                                                                                                                                                               
      643          let mut strategy = FundingBiasStrategy::new(FundingBiasConfig::default());                                                                                                                                                                                                                     
      644                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                  
● Bash(cargo build --release -p quantlaxmi-runner-crypto 2>&1) timeout: 3m 0s                                                                                                                                                                                                                                     
  ⎿     Compiling quantlaxmi-strategy v0.1.0 (/home/isoula/7hills/QuantLaxmi/crates/quantlaxmi-strategy)                                                                                                                                                                                                          
     warning: method `is_flat` is never used                                                                                                                                                                                                                                                                      
        --> crates/quantlaxmi-strategy/src/strategies/funding_bias.rs:265:8                                                                                                                                                                                                                                       
     … +12 lines (ctrl+o to expand)                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                  
● Phase 27.2 Run A: latency_ticks=0                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                  
● Bash(/home/isoula/7hills/QuantLaxmi/target/release/quantlaxmi-crypto backtest --segment-dir /home/isoula/7hills/QuantLaxmi/data/perp_sessions/perp_20260125_133424 --…) timeout: 5m 0s                                                                                                                          
  ⎿  2026-01-29T04:29:33.012734Z  WARN ⚠️  PROMOTION ENFORCEMENT DISABLED - Running in dev mode. Production deployments MUST set --require-promotion to enforce signal promotion status.                                                                                                                           
                                                                                                                                                                                                                                                                                                                  
     ================================================================================                                                                                                                                                                                                                             
     … +49 lines (ctrl+o to expand)                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                  
● Progress! Now have 1 round-trip trade. Let me run both A and B for classification.                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                  
  Phase 27.2 Run B: latency_ticks=1                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                  
● Bash(/home/isoula/7hills/QuantLaxmi/target/release/quantlaxmi-crypto backtest --segment-dir /home/isoula/7hills/QuantLaxmi/data/perp_sessions/perp_20260125_133424 --…) timeout: 5m 0s                                                                                                                          
  ⎿  2026-01-29T04:30:34.012158Z  WARN ⚠️  PROMOTION ENFORCEMENT DISABLED - Running in dev mode. Production deployments MUST set --require-promotion to enforce signal promotion status.                                                                                                                           
                                                                                                                                                                                                                                                                                                                  
     ================================================================================                                                                                                                                                                                                                             
     … +49 lines (ctrl+o to expand)                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                  
● ---                                                                                                                                                                                                                                                                                                             
  Phase 27.2 Results — funding_bias v2.1.0                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                  
  Run A: latency_ticks=0                                                                                                                                                                                                                                                                                          
  ┌────────────────────┬─────────────────────────────┐                                                                                                                                                                                                                                                            
  │       Metric       │            Value            │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Strategy           │ funding_bias:2.1.0:27a9f350 │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Trades             │ 1 (0W / 1L)                 │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Win Rate           │ 0.0%                        │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Max Drawdown       │ $888.05 (8.16%)             │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Total Fees         │ $1.77                       │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Realized PnL       │ -$0.00                      │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Avg Trade Duration │ 23,460s (~6.5h)             │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Decisions          │ 3                           │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Trace Hash         │ c98bd5d1...                 │                                                                                                                                                                                                                                                            
  └────────────────────┴─────────────────────────────┘                                                                                                                                                                                                                                                            
  Run B: latency_ticks=1                                                                                                                                                                                                                                                                                          
  ┌────────────────────┬─────────────────────────────┐                                                                                                                                                                                                                                                            
  │       Metric       │            Value            │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Strategy           │ funding_bias:2.1.0:27a9f350 │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Trades             │ 1 (0W / 1L)                 │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Win Rate           │ 0.0%                        │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Max Drawdown       │ $888.05 (8.16%)             │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Total Fees         │ $1.77                       │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Realized PnL       │ -$0.00                      │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Avg Trade Duration │ 23,460s (~6.5h)             │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Decisions          │ 3                           │                                                                                                                                                                                                                                                            
  ├────────────────────┼─────────────────────────────┤                                                                                                                                                                                                                                                            
  │ Trace Hash         │ 3bac9110...                 │                                                                                                                                                                                                                                                            
  └────────────────────┴─────────────────────────────┘                                                                                                                                                                                                                                                            
  Analysis                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                  
  The strategy now completes entry/exit cycles (1 round-trip), but:                                                                                                                                                                                                                                               
  - trades < 5: Only 1 trade (insufficient sample)                                                                                                                                                                                                                                                                
  - net_pnl ≈ 0: Near-zero PnL (tiny loss from fees)                                                                                                                                                                                                                                                              
  - The funding rate in this segment doesn't swing enough to generate multiple trades                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                  
  The segment has funding rates consistently in the 22-82 (exp -6) range, with limited crossings of the threshold/exit_band boundaries. This 15-hour segment only produced 1 complete trade cycle.                                                                                                                
                                                                                                                                                                                                                                                                                                                  
  Per Phase 27 rules: trades < 5 → NOT EVALUABLE (insufficient sample size)                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                  
  The strategy is now structurally complete (entry + exit), but this segment doesn't provide enough funding rate variation to properly evaluate it. A longer capture period or a different market regime (with more funding rate swings) would be needed.                                                         
                                                                                                                                                                                                                                                                                                                  
✻ Cogitated for 8m 3s                                                                                                                                                                                                                                               
