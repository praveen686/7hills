name: QuantLaxmi CI

on:
  push:
    branches: [main]
    paths:
      - 'crates/**'
      - 'apps/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/quantlaxmi-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'crates/**'
      - 'apps/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/quantlaxmi-ci.yml'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # ISOLATION CHECKS
  # ============================================================================
  isolation:
    name: Isolation Enforcement
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Assert no Kubera crates
        run: |
          if ls crates/ | grep -q kubera; then
            echo "ERROR: Kubera crates found in QuantLaxmi workspace"
            exit 1
          fi

      - name: Assert no Kubera dependencies
        run: |
          if grep -r "kubera" crates/*/src/*.rs 2>/dev/null | grep -v "deprecated\|warning\|comment" | head -5; then
            echo "WARNING: Kubera references found (may be deprecation warnings)"
          fi

      - name: Check runner isolation
        run: |
          # runner-common should not import venue connectors
          if grep -r "quantlaxmi_connectors" crates/quantlaxmi-runner-common/src/*.rs 2>/dev/null; then
            echo "ERROR: runner-common imports venue connectors"
            exit 1
          fi

          # runner-india should not import Binance
          if grep -r "binance\|quantlaxmi_connectors_binance\|quantlaxmi_sbe" crates/quantlaxmi-runner-india/src/*.rs 2>/dev/null; then
            echo "ERROR: runner-india imports crypto code"
            exit 1
          fi

          # runner-crypto should not import Zerodha
          if grep -r "zerodha\|quantlaxmi_connectors_zerodha" crates/quantlaxmi-runner-crypto/src/*.rs 2>/dev/null; then
            echo "ERROR: runner-crypto imports India code"
            exit 1
          fi

          echo "Isolation checks passed"

  # ============================================================================
  # BUILD & TEST
  # ============================================================================
  build:
    name: Build & Test
    runs-on: ubuntu-latest
    needs: isolation
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: nightly
          components: rustfmt, clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check formatting
        run: |
          cargo fmt --all -- --check

      - name: Build (debug)
        run: |
          cargo build --workspace

      - name: Clippy
        run: |
          cargo clippy --workspace -- -D warnings

      - name: Run tests
        run: |
          cargo test --workspace

  # ============================================================================
  # GATES
  # ============================================================================
  gates:
    name: Production Gates
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: nightly

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build gates crate
        run: |
          cargo build -p quantlaxmi-gates

      - name: Run G0 DataTruth on fixture
        run: |
          # Create minimal fixture session
          mkdir -p fixtures/test_session/wal

          # Create session manifest
          cat > fixtures/test_session/session_manifest.json << 'EOF'
          {
            "schema_version": 1,
            "session_id": "fixture-test-001",
            "created_at_utc": "2026-01-25T10:00:00Z",
            "capture_mode": "fixture",
            "out_dir": "fixtures/test_session",
            "duration_secs": 60.0,
            "price_exponent": -2,
            "underlyings": [],
            "tick_outputs": [],
            "integrity": {
              "out_of_universe_ticks_dropped": 0,
              "subscribe_mode": "fixture"
            }
          }
          EOF

          # Create sample market events
          cat > fixtures/test_session/wal/market.jsonl << 'EOF'
          {"ts":"2026-01-25T10:00:00Z","symbol":"BTCUSDT","payload":{"kind":"quote","bid_price_mantissa":9000012,"ask_price_mantissa":9000015,"bid_qty_mantissa":150000000,"ask_qty_mantissa":200000000,"price_exponent":-2,"qty_exponent":-8}}
          {"ts":"2026-01-25T10:00:01Z","symbol":"BTCUSDT","payload":{"kind":"quote","bid_price_mantissa":9000018,"ask_price_mantissa":9000022,"bid_qty_mantissa":150000000,"ask_qty_mantissa":200000000,"price_exponent":-2,"qty_exponent":-8}}
          EOF

          # Run gate tests
          cargo test -p quantlaxmi-gates

      - name: Run G4 Deployability check
        run: |
          cargo test -p quantlaxmi-gates -- g4

  # ============================================================================
  # RELEASE BUILD
  # ============================================================================
  release:
    name: Release Build
    runs-on: ubuntu-latest
    needs: [build, gates]
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: nightly

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-release-

      - name: Build release
        run: |
          cargo build --release --workspace

      - name: Verify binaries exist
        run: |
          ls -la target/release/quantlaxmi-india || echo "India binary not found"
          ls -la target/release/quantlaxmi-crypto || echo "Crypto binary not found"
